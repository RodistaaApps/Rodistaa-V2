name: Figma Token Sync (Automated)

# Runs on schedule or manual trigger
on:
  schedule:
    # Run every Monday at 9 AM UTC (2:30 PM IST)
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Allow manual trigger
    inputs:
      skip_validation:
        description: 'Skip validation step'
        required: false
        default: false
        type: boolean

jobs:
  sync-figma-tokens:
    name: Sync Tokens from Figma
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          
      - name: Install dependencies
        run: |
          cd packages/design-system-automation
          pnpm install
          
      - name: Sync from Figma API
        env:
          FIGMA_TOKEN: ${{ secrets.FIGMA_TOKEN }}
          FIGMA_FILE_KEY: ${{ secrets.FIGMA_FILE_KEY }}
        run: |
          cd packages/design-system-automation
          pnpm figma:sync
          
      - name: Generate TypeScript from tokens
        run: |
          cd packages/design-system-automation
          pnpm tokens:generate
          
      - name: Validate tokens
        if: ${{ !inputs.skip_validation }}
        run: |
          cd packages/design-system-automation
          pnpm tokens:validate
          
      - name: Build design system
        run: |
          cd packages/design-system
          pnpm install
          pnpm build
          
      - name: Check for changes
        id: changes
        run: |
          if [[ -n $(git status -s packages/design-system/tokens/ packages/design-system/src/tokens/) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Token changes detected"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No token changes"
          fi
          
      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore(tokens): sync from Figma [automated]'
          title: 'ðŸŽ¨ Token Sync from Figma [Automated]'
          body: |
            ## ðŸŽ¨ Automated Token Sync from Figma
            
            This PR was automatically created by the Figma token sync workflow.
            
            ### Changes
            - Updated `tokens.json` from Figma API
            - Regenerated TypeScript token files
            - All validation checks passed âœ…
            
            ### Sync Details
            - **Source**: Figma API (automated sync)
            - **Triggered**: ${{ github.event_name }}
            - **Date**: ${{ github.event.head_commit.timestamp }}
            - **Workflow**: figma-token-sync.yml
            
            ### Validation
            - âœ… Token structure valid
            - âœ… Brand compliance (Rodistaa Red #C90D0D)
            - âœ… Font compliance (Baloo Bhai, Times New Roman)
            - âœ… Spacing scale compliant
            - âœ… Build successful
            
            ### Review Checklist
            - [ ] Verify token changes are intentional
            - [ ] Test visual changes in Storybook
            - [ ] Check component rendering
            - [ ] Approve and merge
            
            **Auto-generated by**: `.github/workflows/figma-token-sync.yml`
          branch: automated/figma-token-sync-${{ github.run_number }}
          delete-branch: true
          labels: |
            automated
            tokens
            design-system
            
      - name: Report Status
        if: always()
        run: |
          echo "## Figma Token Sync Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Has Changes**: ${{ steps.changes.outputs.has_changes }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Actions Taken" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Fetched tokens from Figma API" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Generated TypeScript files" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Validated token compliance" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Built design system" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.changes.outputs.has_changes }}" == "true" ]]; then
            echo "- âœ… Created pull request with changes" >> $GITHUB_STEP_SUMMARY
          else
            echo "- â„¹ï¸  No changes to commit" >> $GITHUB_STEP_SUMMARY
          fi


name: CI - Complete Build & Test

on:
  push:
    branches: [develop, master, main]
  pull_request:
    branches: [develop, master, main]

env:
  PNPM_VERSION: 8.15.0
  NODE_VERSION: 20.x

jobs:
  build-and-lint:
    name: Build & Lint All Packages
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages
        run: pnpm -r --filter '!@rodistaa/mobile-*' run build

      - name: Lint code
        run: pnpm -r run lint
        continue-on-error: true

      - name: Type check
        run: |
          cd packages/backend && pnpm run typecheck
          cd $GITHUB_WORKSPACE/packages/acs && pnpm run typecheck

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-output
          path: |
            packages/*/dist
            docs/acs-service/dist
          retention-days: 7

  test-backend:
    name: Backend Unit Tests
    runs-on: ubuntu-latest
    needs: build-and-lint

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: rodistaa
          POSTGRES_PASSWORD: rodistaa_test
          POSTGRES_DB: rodistaa_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run migrations
        run: |
          cd packages/backend
          pnpm run migrate:latest
        env:
          PGHOST: localhost
          PGPORT: 5432
          PGUSER: rodistaa
          PGPASSWORD: rodistaa_test
          PGDATABASE: rodistaa_test

      - name: Run backend tests
        run: cd packages/backend && pnpm test
        continue-on-error: true

  test-acs:
    name: ACS Rule Engine Tests
    runs-on: ubuntu-latest
    needs: build-and-lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ACS tests
        run: cd packages/acs && pnpm test

      - name: Lint ACS rules
        run: cd packages/acs && pnpm run lint:rules

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./packages/acs/coverage/lcov.info
          flags: acs
        continue-on-error: true

  security-scan:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run npm audit
        run: pnpm audit --prod
        continue-on-error: true

      - name: Run Snyk scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

  mobile-lint:
    name: Mobile Apps Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint mobile apps
        run: |
          cd $GITHUB_WORKSPACE/packages/mobile/shipper && pnpm lint
          cd $GITHUB_WORKSPACE/packages/mobile/operator && pnpm lint
          cd $GITHUB_WORKSPACE/packages/mobile/driver && pnpm lint
        continue-on-error: true

  status-check:
    name: CI Status Check
    runs-on: ubuntu-latest
    needs: [build-and-lint, test-backend, test-acs, security-scan, mobile-lint]
    if: always()

    steps:
      - name: Check build status
        run: |
          if [ "${{ needs.build-and-lint.result }}" != "success" ]; then
            echo "Build failed"
            exit 1
          fi
          echo "âœ… All CI checks passed"
